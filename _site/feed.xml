<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>MansM tech babble</title>
    <description>My journey through technology
</description>
    <link>http://0.0.0.0:4000/</link>
    <atom:link href="http://0.0.0.0:4000/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 23 Oct 2018 04:01:21 -0500</pubDate>
    <lastBuildDate>Tue, 23 Oct 2018 04:01:21 -0500</lastBuildDate>
    <generator>Jekyll v3.8.3</generator>
    
      <item>
        <title>Building a homelab with Kubernetes and Raspberry pi's</title>
        <description>&lt;p&gt;&lt;strong&gt;Building a homelab using modern tools/methods like Kubernetes, GitOps and Raspberry Pi’s&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;toc&quot;&gt;
  &lt;h4&gt;Contents&lt;/h4&gt;
&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#why&quot; id=&quot;markdown-toc-why&quot;&gt;Why&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#what&quot; id=&quot;markdown-toc-what&quot;&gt;What&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#who&quot; id=&quot;markdown-toc-who&quot;&gt;Who&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#hardware-i-used&quot; id=&quot;markdown-toc-hardware-i-used&quot;&gt;Hardware I used&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#the-setup&quot; id=&quot;markdown-toc-the-setup&quot;&gt;The setup&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#prerequisites&quot; id=&quot;markdown-toc-prerequisites&quot;&gt;Prerequisites&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#installing-the-master&quot; id=&quot;markdown-toc-installing-the-master&quot;&gt;Installing the master&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#installing-the-node-or-multiple&quot; id=&quot;markdown-toc-installing-the-node-or-multiple&quot;&gt;Installing the node (or multiple)&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#configuring-kubectl&quot; id=&quot;markdown-toc-configuring-kubectl&quot;&gt;Configuring kubectl&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#networking&quot; id=&quot;markdown-toc-networking&quot;&gt;Networking&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#finishing-touches&quot; id=&quot;markdown-toc-finishing-touches&quot;&gt;Finishing touches&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#last-remarks&quot; id=&quot;markdown-toc-last-remarks&quot;&gt;Last remarks&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#what-i-still-want-to-do&quot; id=&quot;markdown-toc-what-i-still-want-to-do&quot;&gt;What I still want to do&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;

&lt;h1 id=&quot;why&quot;&gt;Why&lt;/h1&gt;
&lt;p&gt;In my current job I work a lot with container technologies, and for a lot of items I want to automate the stuff I use at home with the same tech. Unfortunatley, I don’t have the cash for racks full of servers, SAN’s, fiber switches etc etc (my girlfriend would also kill me). So I had to scale down a bit and reuse the equipment I already have.&lt;/p&gt;

&lt;h1 id=&quot;what&quot;&gt;What&lt;/h1&gt;
&lt;p&gt;If your home is a bit like mine, you probably run some services. Mediaplayers, mediaservers, domotica, some websites, etc. I had some spare raspberries laying around so I decided to install kubernetes on them. Kubernetes is an open-source system for deployment, scaling container workloads. Why is this important. If you run just containers on one host it’s easy, but when you do it on multiple you need some system to do it for you.&lt;/p&gt;

&lt;h1 id=&quot;who&quot;&gt;Who&lt;/h1&gt;
&lt;p&gt;This is easy: you&lt;/p&gt;

&lt;h1 id=&quot;hardware-i-used&quot;&gt;Hardware I used&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;Raspberry Pi 2b&lt;/li&gt;
  &lt;li&gt;Raspberry Pi 3b&lt;/li&gt;
  &lt;li&gt;Simple network switch&lt;/li&gt;
  &lt;li&gt;Synology DS1515+ (for persistent storage)&lt;/li&gt;
  &lt;li&gt;Micro USB power cables&lt;/li&gt;
  &lt;li&gt;Flat ethernet cables (as short as possible)&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;the-setup&quot;&gt;The setup&lt;/h1&gt;
&lt;p&gt;«TODO: create diagram»
In this tutorial we will 2 raspberry pi’s.&lt;/p&gt;
&lt;h1 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h1&gt;
&lt;p&gt;First download the latest Hypriot linux build for your raspberry and write them to the sd cards. 
I recommend to give your raspberries static IP’s or give them static IP’s through DHCP. Log in to the raspberries and
give them a nice hostname (when you are at it, dont forget to update). Kubernetes takes the amount of available memory in account, so we need to disable swap. Do this by removing the swap entry from /etc/fstab and the command: &lt;code class=&quot;highlighter-rouge&quot;&gt;swapoff -a&lt;/code&gt;. You have to do this on all hosts.&lt;/p&gt;

&lt;p&gt;Hypriot comes with docker already installed but if you used a different OS image or using vagrant you probably need to install docker yourself.&lt;/p&gt;

&lt;h1 id=&quot;installing-the-master&quot;&gt;Installing the master&lt;/h1&gt;
&lt;p&gt;First we need to install kubeadm. Kubeadm is the tool that manages the lifecycle of a Kubernetes cluster. As kubeadm is not in the default repositories we need to install the kubernetes repository first, before we can use it we also need to add the GPG key:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
add-apt-repository &quot;deb https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;br /&gt;
When we have the repository available we can install kubeadm with the following command: &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install -y kubeadm&lt;/code&gt;&lt;br /&gt;
Kubeadm expects already to have an available kubelet. Kubelet is the component on every kubernetes machine (masters and workers) that starts the pods.
Install kubelet: &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install -y kubelet&lt;/code&gt;. Note: when you are using Vagrant you need to edit the kubelet configuration to use the secondary nic:
open &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/default/kubelet&lt;/code&gt; in your favorite editor and make sure the following line is present: &lt;code class=&quot;highlighter-rouge&quot;&gt;KUBELET_EXTRA_ARGS=--node-ip=192.168.10.10&lt;/code&gt;, where 192.168.10.10 is the ip of the secondairy nic. Restart kubelet afterwards (&lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl restart kubelet&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;The full init process takes a while and can sometimes fail on pulling images. To reduce the chance of this happening, we can prepull the images with:
&lt;code class=&quot;highlighter-rouge&quot;&gt;kubeadm config images pull&lt;/code&gt; Run this until all images are successfully pulled.
«TODO: insert screenshot of kubeadm prefetch»&lt;/p&gt;

&lt;p&gt;Now comes the big step, we will start the initialization process of the cluster. We do this with running the following command:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm init \
  --pod-network-cidr=10.244.0.0/16 \
  --kubernetes-version=1.12.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when using vagrant you need to add: &lt;code class=&quot;highlighter-rouge&quot;&gt;--apiserver-advertise-address=192.168.10.10&lt;/code&gt;, where 192.168.10.10 is the ip of the secondairy nic.
&lt;img src=&quot;/images/2018-11-homelab/kubeadm_init.png&quot; alt=&quot;Kubeadm init output&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As the the Kubernetes apiserver starts slower then amount of it time it has to start kubelet will kill the starting container and tries again. To prevent this, we will need to update the deployment manifest of the apiserver to make sure it gets more time. Open /etc/kubernetes/manifests/kube-apiserver.yaml in your favorite editor (or just use sed) and find this line: &lt;code class=&quot;highlighter-rouge&quot;&gt;failureThreshold: 8&lt;/code&gt;, replace the 8 with 20 and save. Now we need to wait or kill the apiserver by ourselves. To kill the apiserver you can use the command: &lt;code class=&quot;highlighter-rouge&quot;&gt;docker ps -q --filter ancestor=k8s.gcr.io/kube-apiserver:v1.12.1|xargs docker kill&lt;/code&gt;, where v1.12.1 is the same as version mentioned above. Or if you want to do it manually, lookup the docker container with docker ps and find the one that has “kube-apiserver –au…” in the command colomn and kill the container with &lt;code class=&quot;highlighter-rouge&quot;&gt;docker kill containerID=first_column_of_previous_command&lt;/code&gt;. Now you its waiting until it finnishes, the output should look like the screenshot above.&lt;/p&gt;

&lt;h1 id=&quot;installing-the-node-or-multiple&quot;&gt;Installing the node (or multiple)&lt;/h1&gt;
&lt;p&gt;Installing the nodes is a lot similar to installing the masters. We start by installing kubeadm and kubelet (&lt;code class=&quot;highlighter-rouge&quot;&gt;apt install -y kubelet kubeadm&lt;/code&gt;).  Note: when you are using Vagrant you need to edit the kubelet configuration to use the secondary nic:
open &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/default/kubelet&lt;/code&gt; in your favorite editor and make sure the following line is present: &lt;code class=&quot;highlighter-rouge&quot;&gt;KUBELET_EXTRA_ARGS=--node-ip=192.168.10.10&lt;/code&gt;, where 192.168.10.10 is the ip of the secondary nic. Restart kubelet afterwards (systemctl restart kubelet). In the output of the init command of the master a line came how you can have the node join the master. In case you lost this output or you have to wait too long (it expires after 24 hours), you can do it as well with the following command on the master:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm token create  --print-join-command
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On the node we will run the output of the command in the join command
&lt;img src=&quot;/images/2018-11-homelab/kubeadm_join.png&quot; alt=&quot;Kubeadm join output&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;configuring-kubectl&quot;&gt;Configuring kubectl&lt;/h1&gt;
&lt;p&gt;To access the newly Kubernetes cluster we will use the commandline tool called kubectl. Most likely its already installed, but if not you can install it with
&lt;code class=&quot;highlighter-rouge&quot;&gt;apt install -y kubectl&lt;/code&gt;. Kubectl does need to know where to find the Kubernetes apiserver, we can configure this by telling kubectl where the config is located. On the master run &lt;code class=&quot;highlighter-rouge&quot;&gt;export KUBECONFIG=/etc/kubernetes/admin.conf&lt;/code&gt; (it can be smart to put it in your profile). As I am a lazy person I have created an alias called k for kubectl: &lt;code class=&quot;highlighter-rouge&quot;&gt;alias k=kubectl&lt;/code&gt; (you can also save this in your profile).&lt;/p&gt;

&lt;h1 id=&quot;networking&quot;&gt;Networking&lt;/h1&gt;
&lt;p&gt;As Kubernetes allows you to choose which networking plugin you want to use, it comes default without. This is why you nodes show as NotReady:
&lt;img src=&quot;/images/2018-11-homelab/kubectl_get_nodes_not_ready.png&quot; alt=&quot;Kubectl get nodes (notReady)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can fix this by installing flannel (I have chosen Flannel as it comes with auto enablers for multiple platforms (amd64/arm/etc)). On master1 run:
&lt;code class=&quot;highlighter-rouge&quot;&gt;kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/code&gt;
After a short while your nodes will turn to ready:&lt;br /&gt;
&lt;img src=&quot;/images/2018-11-homelab/kubectl_get_nodes_ready.png&quot; alt=&quot;Kubectl get nodes (notReady)&quot; /&gt;&lt;/p&gt;

&lt;p&gt;«TODO: ingress»&lt;/p&gt;

&lt;h1 id=&quot;finishing-touches&quot;&gt;Finishing touches&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;helm?&lt;/li&gt;
  &lt;li&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;last-remarks&quot;&gt;Last remarks&lt;/h1&gt;
&lt;p&gt;As raspberries have a filesystem on an sd flashcard, dont expect it to run forever. Dont keep data here that is really precious to you.&lt;/p&gt;

&lt;h1 id=&quot;what-i-still-want-to-do&quot;&gt;What I still want to do&lt;/h1&gt;
&lt;p&gt;Adding monitoring
Adding logging
Using PoE powered Raspberry Pi 3b+
Using MetalLB with Ubiquiti USG for&lt;/p&gt;

</description>
        <pubDate>Sun, 30 Sep 2018 12:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/kuberetes/raspberry/rpi/2018/09/30/building-homelab.html</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/kuberetes/raspberry/rpi/2018/09/30/building-homelab.html</guid>
        
        <category>Kuberetes</category>
        
        <category>Raspberry</category>
        
        <category>rpi</category>
        
        
        <category>Kuberetes</category>
        
        <category>Raspberry</category>
        
        <category>rpi</category>
        
      </item>
    
      <item>
        <title>Starting fresh with Jenkins 2.0</title>
        <description>&lt;p&gt;&lt;strong&gt;Now Jenkins 2 recently got released it was time for me to start using it. Just changing the tag number of the Docker image was not enough. 
In this post I will describe what you need to do to get started.&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;toc&quot;&gt;
  &lt;h4&gt;Contents&lt;/h4&gt;

&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#tooling&quot; id=&quot;markdown-toc-tooling&quot;&gt;Tooling&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#jenkins-2&quot; id=&quot;markdown-toc-jenkins-2&quot;&gt;Jenkins 2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#dockerfile&quot; id=&quot;markdown-toc-dockerfile&quot;&gt;Dockerfile&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#jenkinsfile&quot; id=&quot;markdown-toc-jenkinsfile&quot;&gt;Jenkinsfile&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;

&lt;h2 id=&quot;tooling&quot;&gt;Tooling&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Docker&lt;/li&gt;
  &lt;li&gt;Text editor&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;jenkins-2&quot;&gt;Jenkins 2&lt;/h2&gt;
&lt;p&gt;In Jenkins 2 one of the main new features is “Pipeline as code”. Your pipeline/build steps are now bundled with your code in your git/svn repo. 
To have the buildsteps defined as code has some advantages, but for me the biggest one is as your project evolves your build steps will probably evolve as well. So when for some reason you need to go back in time (perhaps to fix a production issue) you will build with the steps that are required for that moment in time.
The can configure the buildsteps in a file called “Jenkinsfile”.&lt;/p&gt;

&lt;p&gt;In the example below I have added some of the items I use a lot myself. 
The language in the script is Jenkins DSL, which is almost identical to groovy.&lt;/p&gt;

&lt;h2 id=&quot;dockerfile&quot;&gt;Dockerfile&lt;/h2&gt;
&lt;p&gt;As most Docker projects you need a Dockerfile. We are using the official &lt;a href=&quot;https://hub.docker.com/_/jenkins/&quot;&gt;Jenkins&lt;/a&gt; Dockerimage as a base (line 1).
Jenkins relies heavily on plugins. To add plugins we use a &lt;a href=&quot;/images/plugins.txt&quot;&gt;file&lt;/a&gt; with all the required plugins. With the plugins file I use, Jenkins still wants to get some more… So don’t be alarmed when you see a message of this starting it the first time. To install the plugins during the build of the Docker image we copy the plugins.txt into the image (line 3) and use it as a source when executing the plugin installer (line 4).&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jenkinsci&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;2.7&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#plugins&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;COPY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;txt&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/usr/s&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hare&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;txt&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;RUN&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/usr/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/usr/s&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hare&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;txt&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;#config&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;COPY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webapp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/usr/s&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hare&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webapp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;xml&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;COPY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/usr/s&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hare&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ref&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;xml&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#Adding Jenkins user to the correct groups&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;RUN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;usermod&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;G&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;users&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;RUN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;usermod&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;G&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jenkins&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h2 id=&quot;jenkinsfile&quot;&gt;Jenkinsfile&lt;/h2&gt;
&lt;p&gt;The Jenkinsfile in here is just an example of what you can do. It is not really a working script as I would never use scripts called somescript.sh ;-) .&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-groovy&quot; data-lang=&quot;groovy&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  
  &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;prepare&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;checkout&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scm&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;build&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'docker-buildslave-centos7'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;withCredentials&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;([[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;$class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'UsernamePasswordMultiBinding'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;credentialsId:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'foo-credenitals'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;passwordVariable:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'FOO_PASS'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;usernameVariable:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'FOO_USER'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;sed -i 's/CHANGEUSER/${env.FOO_USER}/g' somescript.sh&quot;&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;sed -i 's/CHANGEPASS/${env.FOO_PASS}/g' somescript.sh&quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;chmod +x somescript.sh&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./somescript.sh&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;stash&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;includes:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'*.bin'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;name:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'bins'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;useDefaultExcludes:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;test&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'docker-test-centos7'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;checkout&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scm&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;unstash&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bins&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;./testscript.sh&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;store&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;unstash&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bins&lt;/span&gt;
  &lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Upload&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;somewhere&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

</description>
        <pubDate>Wed, 27 Apr 2016 12:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/docker/jenkins/jenkinsfile/2016/04/27/jenkins-2.0.html</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/docker/jenkins/jenkinsfile/2016/04/27/jenkins-2.0.html</guid>
        
        <category>Docker</category>
        
        <category>Jenkins</category>
        
        <category>Jenkinsfile</category>
        
        
        <category>Docker</category>
        
        <category>Jenkins</category>
        
        <category>Jenkinsfile</category>
        
      </item>
    
      <item>
        <title>Presentation about Nomad</title>
        <description>&lt;p&gt;&lt;strong&gt;During the March Hashicorp Meetup in Amsterdam I gave a talk on Nomad. Video and slides inside&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;My focus during this presentation was on the possibilties of Nomad while using the jobfile.&lt;/p&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/ISpnVbwwcLk&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;script async=&quot;&quot; class=&quot;speakerdeck-embed&quot; data-id=&quot;30d61850f67446e4abd62199f00ebebc&quot; data-ratio=&quot;1.77777777777778&quot; src=&quot;//speakerdeck.com/assets/embed.js&quot;&gt;&lt;/script&gt;

</description>
        <pubDate>Sun, 13 Mar 2016 12:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/presentation/nomad/hashicorp/meetup/2016/03/13/Presentation-on-Nomad.html</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/presentation/nomad/hashicorp/meetup/2016/03/13/Presentation-on-Nomad.html</guid>
        
        <category>Presentation</category>
        
        <category>Nomad</category>
        
        <category>Hashicorp</category>
        
        <category>Meetup</category>
        
        
        <category>Presentation</category>
        
        <category>Nomad</category>
        
        <category>Hashicorp</category>
        
        <category>Meetup</category>
        
      </item>
    
      <item>
        <title>Extending your HA over multiple machines</title>
        <description>
&lt;p&gt;&lt;strong&gt;In the last article we discussed how you can scale your webapplication with Docker. In this article I will show you how you can scale your
Docker environments over multiple servers and/or datacenters using Nomad.This post will be a focussed on building infrastructure.&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;toc&quot;&gt;
  &lt;h4&gt;Contents&lt;/h4&gt;

&lt;/div&gt;

&lt;p&gt;##Tooling&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Docker: Container management software&lt;/li&gt;
  &lt;li&gt;Nomad: A distributed, high available. datacenter-aware scheduler&lt;/li&gt;
  &lt;li&gt;Consul: A tool for service discovery and configuration&lt;/li&gt;
  &lt;li&gt;Ansible (version 2): platform for deploying software and configuration management&lt;/li&gt;
  &lt;li&gt;Git: Version control system for source code&lt;/li&gt;
  &lt;li&gt;Virtualbox: Free hypervisor&lt;/li&gt;
  &lt;li&gt;Vagrant: Wrapper around virtualbox, which allows you to script vm provisioning.&lt;/li&gt;
  &lt;li&gt;Webapp &amp;amp; haproxy: basic 2-tier application which is described in the previous post&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On your local machine you need to install vagrant, virtualbox and ansible. I can highly recommed using chocolatey on windows or brew on osx for
installing the applications. Keep in mind you need to install version 2 of ansible (brew install –devel ansible), this because I need to use some 
functionality that is not available in version 1.x .&lt;/p&gt;

&lt;p&gt;##Overview
To create an high available environment we need to make sure all parts are redundant available. This result in every server
being available more then once. More servers will result in higher memmory usage. I have ran this setup with ease on my 8GB 2012 MacBook Air.
In the image below the architecture of the solution is shown:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016-01-scaling-your-docker-environment/overview.png&quot; alt=&quot;Servers overview&quot; /&gt;&lt;/p&gt;

&lt;p&gt;##Ansible
I normally use puppet for my configuration management, but during this project I decided to use ansible. For a small environment ansible is very
easy to use and gets the job done. As this is my first ever usage of ansible, I will probably have created some code that should be done 
differently. Feel free to give feedback.&lt;/p&gt;

&lt;p&gt;##Nomad
As mentioned earlier, nomad is a scheduler. Nomad was designed with Docker in mind, but also allows you to run “system” jobs, by example docker-engine.&lt;/p&gt;

&lt;p&gt;##Networking
In most large enterprises a lot of applications are getting webbased. This results in the dockerized webapps be available on an routeable address.
I used 10.50.x.x/16 so I have enough address space.&lt;/p&gt;

&lt;p&gt;##Servers&lt;/p&gt;

&lt;p&gt;###Nomadservers
On the machines with the name nomadserver1 and nomadserver2 the following components will be installed and configured:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;consul&lt;/li&gt;
  &lt;li&gt;bind&lt;/li&gt;
  &lt;li&gt;nomad&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;All of this is done by ansible. In the playbook for this project, which is partly shown below, you can see the applications being
setup by using roles.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nomadserver*&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;become&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;vars&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
   &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;consul_type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;server&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;roles&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;consul&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bind&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nomad&lt;/span&gt;

&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nomadserver2&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;become&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;tasks&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;consul cluster maken&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/usr/bin/consul join&lt;/span&gt; 
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nomad cluster maken&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;NOMAD_ADDR&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;http://:4646&quot;&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;shell&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/usr/bin/nomad server-join&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;On the nomadservers the consul is running in server mode and form together a cluser. All the consul agents running in next to 
“businessapplications” are running in client mode.&lt;/p&gt;

&lt;p&gt;###Dockerservers&lt;/p&gt;
</description>
        <pubDate>Thu, 31 Dec 2015 11:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/docker/consul/nomad/ansible/2015/12/31/extending-ha.html</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/docker/consul/nomad/ansible/2015/12/31/extending-ha.html</guid>
        
        <category>Docker</category>
        
        <category>consul</category>
        
        <category>nomad</category>
        
        <category>ansible</category>
        
        
        <category>Docker</category>
        
        <category>consul</category>
        
        <category>nomad</category>
        
        <category>ansible</category>
        
      </item>
    
      <item>
        <title>Scaling your web application with Docker</title>
        <description>&lt;p&gt;&lt;strong&gt;Imagine, the web application you developed has suddenly become quite popular and you need to scale up. In the old days this required installing another virtual 
machine, which takes loads of time. Now, with the solution provided here, scaling up and down can be done in an instant. In this article I will show you how you 
can build an highly scalable environment for your web apps using Docker containers.&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;toc&quot;&gt;
  &lt;h4&gt;Contents&lt;/h4&gt;

&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#tooling&quot; id=&quot;markdown-toc-tooling&quot;&gt;Tooling&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#overview&quot; id=&quot;markdown-toc-overview&quot;&gt;Overview&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#how-to-start-docker&quot; id=&quot;markdown-toc-how-to-start-docker&quot;&gt;How to start Docker&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#docker-containers&quot; id=&quot;markdown-toc-docker-containers&quot;&gt;Docker containers&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#consul-server&quot; id=&quot;markdown-toc-consul-server&quot;&gt;Consul server&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#web-application&quot; id=&quot;markdown-toc-web-application&quot;&gt;Web application&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#dockerfile&quot; id=&quot;markdown-toc-dockerfile&quot;&gt;Dockerfile&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#webjson&quot; id=&quot;markdown-toc-webjson&quot;&gt;web.json&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#supervisordconf&quot; id=&quot;markdown-toc-supervisordconf&quot;&gt;supervisord.conf&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#load-balancer&quot; id=&quot;markdown-toc-load-balancer&quot;&gt;Load balancer&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#dockerfile-1&quot; id=&quot;markdown-toc-dockerfile-1&quot;&gt;Dockerfile&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#haproxyctmpl&quot; id=&quot;markdown-toc-haproxyctmpl&quot;&gt;haproxy.ctmpl&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#haproxyjson&quot; id=&quot;markdown-toc-haproxyjson&quot;&gt;haproxy.json&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#docker-compose&quot; id=&quot;markdown-toc-docker-compose&quot;&gt;Docker Compose&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#docker-composeyml&quot; id=&quot;markdown-toc-docker-composeyml&quot;&gt;docker-compose.yml&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#conclusion&quot; id=&quot;markdown-toc-conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#sources&quot; id=&quot;markdown-toc-sources&quot;&gt;Sources&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; is an open source tool for building and running containers. Containers are an all-in-one package filled with the application and its dependencies.
The benefit of using containers is that it runs directly on the operating system, which saves you from a virtualization layer. Every container runs
separately, so your environment will be multi-tennant safe.&lt;/p&gt;

&lt;h2 id=&quot;tooling&quot;&gt;Tooling&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Docker: In the current IT environment there is never enough speed, VM’s are slow and containers are hot. Docker is currently the most popular 
container software.&lt;/li&gt;
  &lt;li&gt;Docker-compose: Tool for defining and launching multi-container applications.&lt;/li&gt;
  &lt;li&gt;Haproxy: Open source load balancer for TCP and HTTP based services&lt;/li&gt;
  &lt;li&gt;Consul: A tool for service discovery and configuration&lt;/li&gt;
  &lt;li&gt;Apache with PHP: Just an example of a web application, but you can use any other web application type&lt;/li&gt;
  &lt;li&gt;Supervisor: As we run next to the primary process a Consul application in the container we need something to launch them&lt;/li&gt;
  &lt;li&gt;Virtualbox: Free hypervisor, supplied with Docker toolbox&lt;/li&gt;
  &lt;li&gt;Git: Version control system for source code&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Of the list above you only need to install the Docker toolbox. You can find it at the Docker &lt;a href=&quot;https://www.docker.com/docker-toolbox&quot;&gt;website&lt;/a&gt;. Make sure you 
have the docker “default” virtual machine created by opening Docker Kitematic (container monitor shipped with Docker toolbox) or use ‘docker-machine create’ to create it.&lt;/p&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;
&lt;p&gt;In the image below you can see how the environment will be. As you can see I use three different parts of consul: the agent, the server and template. 
The agent tells the server it is online and which services the machine/container has available. Consul-template queries the server and replaces the 
configuration file of Haproxy which it also restarts. On shutting down a webserver the Consul agent notifies the server it is leaving and Consul-template 
will remove the server from the configuration file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/overview.png&quot; alt=&quot;Container overview&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;how-to-start-docker&quot;&gt;How to start Docker&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;For Windows users:
I prefer to use Git Bash instead of Docker Quickstart Terminal because it allows easy pasting (shift+insert).&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;After you installed the Docker Toolbox, you’re almost ready to go. We only need to do the following steps:&lt;/p&gt;

&lt;p&gt;Open a terminal/command line and create a new Docker-machine with the command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;docker-machine create &lt;span class=&quot;nt&quot;&gt;--driver&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;virtualbox&quot;&lt;/span&gt; default&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;To prevent the other Docker tooling (like the Quickstart Terminal or Kitematic) creating a new Docker virtual machine, I’ve used the default name ‘default’.
On starting the terminal/command line you will have to direct to the location of the Docker-machine (when you forget: you will get an error about not be able to connect:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;eval&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-machine env default)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h2 id=&quot;docker-containers&quot;&gt;Docker containers&lt;/h2&gt;
&lt;p&gt;Three different containers can be identified:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Consul server&lt;/li&gt;
  &lt;li&gt;Load balancer with Consul-template&lt;/li&gt;
  &lt;li&gt;Web service with Consul agent&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;First of all, get the Git repository with the example code:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;git clone https://github.com/MansM/docker-scalingdemo.git&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h3 id=&quot;consul-server&quot;&gt;Consul server&lt;/h3&gt;
&lt;p&gt;Change to the folder in your terminal or Windows command line where the Git repository is located. The Consul server is the ‘consul-server’ container made by Gliderlabs, to start it:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; consul &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8500:8500 gliderlabs/consul-server &lt;span class=&quot;nt&quot;&gt;-bootstrap-expect&lt;/span&gt; 1&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;To view the Consul server UI, you can browse to the docker_ip:8500, you can locate the IP with running the command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker-machine ip default &lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;If ‘default’ is not the correct Docker-machine, find the correct one with “docker-machine ls”.&lt;/p&gt;

&lt;p&gt;You should now see something like:
&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/consul-ui.png&quot; alt=&quot;Consul UI&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;web-application&quot;&gt;Web application&lt;/h3&gt;
&lt;p&gt;Now it’s time to add a webserver to the pool. First of all we need to build and run the Docker container:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker build &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; apachephp apachephp
docker run  &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; web &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8080:80 &lt;span class=&quot;nt&quot;&gt;--link&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;consul&quot;&lt;/span&gt; apachephp&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;When you refresh the Consul UI screen, you will see the web server has been added. 
&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/consul-ui-web.png&quot; alt=&quot;Consul UI with webserver&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the command to start the web server I have used the option ‘link’. Setting this parameter Docker will link the mentioned container to the new container.&lt;/p&gt;

&lt;h4 id=&quot;dockerfile&quot;&gt;Dockerfile&lt;/h4&gt;
&lt;p&gt;The main item of any Docker container is the Dockerfile, this contains the building steps from which Docker builds the image.
In this case the base image we are using is PHP including Apache (line 1). On line 4 we install Supervisor and two
utilities to get the rest of the Dockerfile working. The Consul agent is downloaded and installed on line 9. The configuration for 
Supervisor and Consul is copied into the image on line 12 and 13. The last line is the command which will be executed on launching the container, 
in this case starting Supervisor to launch the other processes.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-docker&quot; data-lang=&quot;docker&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; php:5.6-apache&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; CONSUL_AGENT_VERSION=0.5.2&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt-get update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; supervisor wget unzip
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt-get clean

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /var/log/supervisor
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /etc/consul.d 
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;wget https://releases.hashicorp.com/consul/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CONSUL_AGENT_VERSION&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/consul_&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CONSUL_AGENT_VERSION&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;_linux_amd64.zip &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /tmp/consul-agent.zip &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; unzip /tmp/consul-agent.zip &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;consul /usr/local/bin

&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; src/ /var/www/html/&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; supervisord.conf /etc/supervisor/conf.d/supervisord.conf&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; web.json /etc/consul.d/web.json&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; [&quot;/usr/bin/supervisord&quot;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h4 id=&quot;webjson&quot;&gt;web.json&lt;/h4&gt;
&lt;p&gt;This file is the configuration for the Consul agent. The service web is the selector which later will be used to identify the needed containers. Line 7 is quite important, it
makes the agent notify the server it is leaving when the container is stopped. This will save you from deregistering every stopped node in the Consul UI.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;service&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;web&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tags&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;php&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;leave_on_terminate&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h4 id=&quot;supervisordconf&quot;&gt;supervisord.conf&lt;/h4&gt;
&lt;p&gt;In the configuration file for Supervisor we mention that Supervisor should not be started as a daemon. The output will now be shown directly instead of being written to 
log files (and retrievable with “docker logs”).&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nn&quot;&gt;[supervisord]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;nodaemon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[program:apache]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/usr/local/bin/apache2-foreground&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[program:consulagent]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;consul agent -data-dir=/tmp/consul -join consul -config-dir /etc/consul.d&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h3 id=&quot;load-balancer&quot;&gt;Load balancer&lt;/h3&gt;
&lt;p&gt;The final container in the setup is the load balancer. You can start it with the following commands:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;docker build &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; loadbalancer haproxy
docker run &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 80:80 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 9000:9000 &lt;span class=&quot;nt&quot;&gt;--link&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;consul&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--link&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;web&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; loadbalancer loadbalancer&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;The load balancer exists of two main components: Consul-template and Haproxy. I have chosen Haproxy in this setup so I can switch to non-HTTP backends as well.
In your browser go to docker_ip:9000/haproxy_stats (User/Pass: admin) to see the statistics page of Haproxy, which shows a single backend webserver.
&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/haproxy.png&quot; alt=&quot;Haproxy&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;dockerfile-1&quot;&gt;Dockerfile&lt;/h4&gt;
&lt;p&gt;The Dockerfile of the load balancer consists of installing the software (line 5 &amp;amp; 6) and copying configuration files into the image (line 9 &amp;amp; 10).&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-docker&quot; data-lang=&quot;docker&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; debian:latest&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;MAINTAINER&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; Mans Matulewicz&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; CONSUL_TEMPLATE_VERSION=0.10.0&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt-get update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; haproxy wget unzip
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; wget &lt;span class=&quot;nt&quot;&gt;--no-check-certificate&lt;/span&gt; https://github.com/hashicorp/consul-template/releases/download/v&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CONSUL_TEMPLATE_VERSION&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/consul-template_&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CONSUL_TEMPLATE_VERSION&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;_linux_amd64.tar.gz &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /tmp/consul_template.tar.gz &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;gunzip&lt;/span&gt; /tmp/consul_template.tar.gz &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /tmp &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;xf /tmp/consul_template.tar &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /tmp/consul-template&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;consul-template /usr/bin &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /tmp/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apt-get clean

&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; haproxy.ctmpl /etc/haproxy.ctmpl&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; haproxy.json /etc/haproxy.json&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;EXPOSE&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; 80/tcp 9000/tcp&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; [&quot;consul-template&quot;, &quot;-config=/etc/haproxy.json&quot;, &quot;-consul=consul:8500&quot;]&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h4 id=&quot;haproxyctmpl&quot;&gt;haproxy.ctmpl&lt;/h4&gt;
&lt;p&gt;Below is only a part of the Haproxy configuration file, the part that is modified by Consul-template. At line 7 the loop starts for every node that delivers the service web 
and it will create a line for every available server. Usually the word ‘check’ is placed at the end of every server-line to make Haproxy check for the availability of the server, 
however this is not necessary in this setup.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-nginx&quot; data-lang=&quot;nginx&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;k&quot;&gt;backend&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nodes&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;mode&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;http&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;option&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;forwardfor&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;http-request&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;set-header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Forwarded-Port&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;%[dst_port]&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;http-request&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;add-header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Forwarded-Proto&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;https&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;ssl_fc&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;option&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;httpchk&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;HEAD&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;HTTP/1.1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nHost:localhost&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;roundrobin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;service&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;web&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}}&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;.Node&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;.Address&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;.Port&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}}&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h4 id=&quot;haproxyjson&quot;&gt;haproxy.json&lt;/h4&gt;
&lt;p&gt;This is the configuration file for Consul-template. Using the source template file, it will generate the destination configuration file and will invoke Haproxy with the newly created
configuration file.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;nx&quot;&gt;template&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/etc/haproxy.ctmpl&quot;&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;destination&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/etc/haproxy/haproxy.cfg&quot;&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;haproxy -f /etc/haproxy/haproxy.cfg -sf $(pidof haproxy) &amp;amp;&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;With the information above I have shown you how Docker works and how you can manually spin up multiple containers to build a Docker environment. In the next part I will show you
how you can simplify this and finally we get to scaling.&lt;/p&gt;

&lt;h2 id=&quot;docker-compose&quot;&gt;Docker Compose&lt;/h2&gt;
&lt;p&gt;Until now we have started all the containers one by one, but there is a more easy way to do it. We will using Compose, which is shipped with the Docker Toolbox. 
Before we can use it, we have to make sure all the manually started containers are gone, to prevents conflicts with ports. Below you can see the running containers:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;Manss-MacBook-Air:~ Mans&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;docker ps
CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS                                                                                NAMES
c475f80693b9        loadbalancer               &lt;span class=&quot;s2&quot;&gt;&quot;consul-template -con&quot;&lt;/span&gt;   3 seconds ago       Up 3 seconds        0.0.0.0:80-&amp;gt;80/tcp, 0.0.0.0:9000-&amp;gt;9000/tcp                                           loadbalancer
ffd06220716f        apachephp                  &lt;span class=&quot;s2&quot;&gt;&quot;/usr/bin/supervisord&quot;&lt;/span&gt;   17 seconds ago      Up 17 seconds       0.0.0.0:8080-&amp;gt;80/tcp                                                                 web
16df4e7a5e64        gliderlabs/consul-server   &lt;span class=&quot;s2&quot;&gt;&quot;/bin/consul agent -s&quot;&lt;/span&gt;   29 seconds ago      Up 28 seconds       8300-8302/tcp, 8400/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&amp;gt;8500/tcp   consul&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;To stop them use the following command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;docker stop loadbalancer web consul&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;To start all the containers of this project, use the command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;docker-compose up&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;It will start all the containers and show the logging output in the terminal/command line.&lt;/p&gt;

&lt;p&gt;Now it’s time for the stuff its all about: scaling! To increase the amount of web servers to 5, you just have to give this command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;nx&quot;&gt;Manss&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;MacBook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Air&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;scalingdemo&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Mans$&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;docker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;compose&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;scale&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;web&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;Creating&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;starting&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;done&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;Creating&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;starting&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;done&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;Creating&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;starting&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;done&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;Creating&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;starting&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;p&gt;Within a couple of seconds you are now running your web application on 5 webservers: 
&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/consul-ui-upscaled.png&quot; alt=&quot;Consul UI upscaled&quot; /&gt;
&lt;img src=&quot;/images/2015-12-05-scaling-your-webapplication-with-docker/haproxy-upscaled.png&quot; alt=&quot;Haproxy upscaled&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;docker-composeyml&quot;&gt;docker-compose.yml&lt;/h3&gt;
&lt;p&gt;All the magic of Compose is configured in the docker-compose.yml listed below. In essence it is just listing all the containers and the runtime 
parameters.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;
  &lt;pre&gt;&lt;code class=&quot;language-javascript&quot; data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;nx&quot;&gt;consul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;gliderlabs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;consul&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;server&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;bootstrap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;expect&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;8500:8500&quot;&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;loadbalancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;haproxy&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;80:80&quot;&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;9000:9000&quot;&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;links&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;web&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;consul&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;web&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;apachephp&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;links&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;consul&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/figure&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Creating an highly scalable environment is not hard, as this blogpost will have shown you. It is usable for containers as well for virtual machines (if you really want to).
In a later post I will add Docker swarm to the mix and extend the functionality over multiple (Docker-)machines.&lt;/p&gt;

&lt;h2 id=&quot;sources&quot;&gt;Sources&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;http://sirile.github.io/2015/05/18/using-haproxy-and-consul-for-dynamic-service-discovery-on-docker.html&lt;/li&gt;
  &lt;li&gt;http://technologyconversations.com/2015/07/02/scaling-to-infinity-with-docker-swarm-Docker-compose-and-consul-part-14-a-taste-of-what-is-to-come/&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sat, 05 Dec 2015 11:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/docker/consul/2015/12/05/scaling-your-webapplication-with-docker.html</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/docker/consul/2015/12/05/scaling-your-webapplication-with-docker.html</guid>
        
        <category>Docker</category>
        
        <category>consul</category>
        
        
        <category>Docker</category>
        
        <category>consul</category>
        
      </item>
    
  </channel>
</rss>
